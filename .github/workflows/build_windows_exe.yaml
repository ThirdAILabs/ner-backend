name: Build Windows Exe

# Kills old jobs from the same pr if we push a new commit
# See https://stackoverflow.com/questions/66335225/how-to-cancel-previous-runs-in-the-pr-when-you-push-new-commitsupdate-the-curre
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


on: 
  push:
    branches: [windows-exe]
  workflow_dispatch:  

jobs:
  build_windows_exe:
    runs-on: windows-2022
    steps:
      - name: Checkout ner-backend
        uses: actions/checkout@v2
        with:
          path: ${{ github.workspace }}/ner-backend/

      - name: Checkout Universe
        uses: actions/checkout@v2
        with:
          path: ${{ github.workspace }}/Universe/
          submodules: 'recursive'
          token: ${{ secrets.UNIVERSE_ACCESS_TOKEN }}
      
      - name: ls stuff 1
        run: |
          ls $GITHUB_WORKSPACE
        shell: powershell
      - name: ls stuff 2
        run: |
          ls $GITHUB_WORKSPACE/ner-backend
        shell: powershell
      - name: ls stuff 3
        run: |
          ls $GITHUB_WORKSPACE/Universe
        shell: powershell

      - name: Install dependencies with vcpkg
        working-directory: C:\vcpkg
        run: |
          $Env:VCPKG_BUILD_TYPE = 'release'
          $Env:VCPKG_DEFAULT_TRIPLET = 'x64-windows-static'
          $Env:VCPKG_ROOT = 'C:\'
          .\vcpkg install zlib:x64-windows-static
          .\vcpkg upgrade --no-dry-run # In case there are new builds available after cache restoration
        shell: powershell

      - name: Build Universe libs
        working-directory: ${{ github.workspace }}/Universe/
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DENABLE_COMPRESSION=OFF -DTHIRDAI_GTEST_DISCOVERY_TIMEOUT=30 -DVCPKG_TARGET_TRIPLET=x64-windows-static -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake
          cmake --build build --target thirdai 
          ls build
          ls build/deps/rocksdb
          ls build/deps/utf8proc
          ls build/deps/spdlog
          ls $GITHUB_WORKSPACE
        shell: powershell